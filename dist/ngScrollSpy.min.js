/*
Copyright (c) 2014 Magnús Örn Gylfason
Licence: MIT
*/
!function(t){"use strict";function n(){return o}var e=t.module("ngScrollSpy",[]);e.service("ScrollSpy",["$window",function(n){var e,o=function(t){var n={width:t.innerWidth,height:t.innerHeight,maxWidth:t.document.body.scrollWidth,maxHeight:t.document.body.scrollHeight,posX:t.scrollX||t.pageXOffset||t.document.documentElement.scrollLeft,posY:t.scrollY||t.pageYOffset||t.document.documentElement.scrollTop};return n.posX<0?(n.posX=0,n.overscrollLeft=!0):n.posX+n.width>n.maxWidth&&(n.posX=n.maxWidth-n.width,n.overscrollRight=!0),n.posY<0?(n.posY=0,n.overscrollTop=!0):n.posY+n.height>n.maxHeight&&(n.posY=n.maxHeight-n.height,n.overscrollBottom=!0),n.hasOverscroll=n.overscrollTop||n.overscrollBottom||n.overscrollLeft||n.overscrollRight,n},r=function(n,e){if(!n||!e)return t.extend({isEqual:!1,velocityX:0,velocityY:0},e);var o={posX:e.posX-n.posX,posY:e.posY-n.posY,width:e.width-n.width,height:e.height-n.height,maxWidth:e.maxWidth-n.maxWidth,maxHeight:e.maxHeight-n.maxHeight};return e.width>0&&(o.velocityX=o.posX/e.width),e.height>0&&(o.velocityY=o.posY/e.height),o.isEqual=!(0!==o.posX||0!==o.posY||0!==o.width||0!==o.height||0!==o.maxWidth||0!==o.maxHeight),o},i={},l=function(t){var l=o(n),s=r(e,l);if(!s.isEqual||l.hasOverscroll||t){for(var c in i){var u=i[c].cond;(u(l,s)||t)&&i[c].handler(l,s)}e=l}};t.element(n).on("scroll",l);var s=this,c=0;this.trigger=function(){this.isForced=!0,l(!0),this.isForced=!1},this.addHandler=function(t,n){return i[c]={cond:t,handler:n},c++,c-1},this.removeHandler=function(t){delete i[t]},this.onScroll=function(t){return s.addHandler(function(){return!0},function(n,e){t(n,e)})},this.onXScroll=function(t){return s.addHandler(function(t,n){return 0!==n.posX},function(n,e){t(n.posX,e.posX,n,e)})},this.onYScroll=function(t){return s.addHandler(function(t,n){return 0!==n.posY},function(n,e){t(n.posY,e.posY,n,e)})},this.onOverscrollHorz=function(t){return s.addHandler(function(t){return t.overscrollLeft||t.overscrollRight},t)},this.onOverscrollLeft=function(t){return s.addHandler(function(t){return t.overscrollLeft},t)},this.onOverscrollRight=function(t){return s.addHandler(function(t){return t.overscrollRight},t)},this.onOverscrollVert=function(t){return s.addHandler(function(t){return t.overscrollTop||t.overscrollBottom},t)},this.onOverscrollTop=function(t){return s.addHandler(function(t){return t.overscrollTop},t)},this.onOverscrollBottom=function(t){return s.addHandler(function(t){return t.overscrollBottom},t)}}]),e.directive("affix",["ScrollSpy",function(t){var n,e=function(t,n,e,o){var r=t(o[0].getBoundingClientRect());r!==n&&(r?o.addClass(e):o.removeClass(e))},o=function(o,r,i){var l,s=!1,c=!1,u=!1;"top"===o?n=t.onYScroll(function(t){c=s,e(function(n){return s?s=t>=l:n.top<=0?(l=n.top<0?t+n.top:t,s=!0):!1},c,r,i)}):"bottom"===o?(u=!0,n=t.onYScroll(function(n,o,u){c=s,e(function(e){return s?s=l>=n:e.bottom>=u.height?(l=t.isForced&&0===n?n+e.bottom-u.height-e.height:n+e.bottom-u.height,s=!0):!1},c,r,i)})):"left"===o?n=t.onXScroll(function(t){c=s,e(function(n){return s?s=t>=l:n.left<=0?(l=n.left<0?t+n.left:t,s=!0):!1},c,r,i)}):"right"===o&&(u=!0,n=t.onXScroll(function(n,o,u){c=s,e(function(e){return s?s=l>=n:e.right>=u.width?(l=t.isForced&&0===n?n+e.right-u.width-e.width:n+e.right-u.width,s=!0):!1},c,r,i)})),u&&t.trigger()};return{restrict:"A",scope:{affix:"@",affixClass:"@"},link:function(e,r){e.affix=e.affix||"top",e.affixClass=e.affixClass||"affix",o(e.affix,e.affixClass,r),e.$on("destroy",function(){t.removeHandler(n)})}}}]);var o={onRun:null,state:null,store:function(t){for(var n in t)this[n]=t[n];this.state=!0,this.run()},builder:null,setBuilder:function(t){this.builder=t,this.run()},run:function(){this.builder&&this.state&&(this.builder(),this.state=null,this.onRun&&this.onRun())}};e.directive("pageitems",["ScrollSpy","$timeout",function(e,o){var r=function(r,i){if(t.isDefined(r.selector)){r.spies={},r.spyElems=[],r.topmargin=0;var l=!1;r.$watch(function(){return i[0].childNodes.length},function(t,e){t===e&&l||o(function(){l=!0,r.spyElems=i[0].getElementsByClassName(r.selector),r.spies={},n().onRun=function(){r.spies[r.spyElems[0].id].set()},n().store({topMargin:function(){return 0|r.topmargin},addSpy:function(t){r.spies[t.id]=t},getSpy:function(t){return r.spies[t]},items:function(){return r.spyElems}})},1e3)});var s=e.onYScroll(function(t,n,e){for(var o=null,i=r.spies,l=0;l<r.spyElems.length;l++){var s=r.spyElems[l],c=i[s.id];if(c.clear(),void 0!==s.getBoundingClientRect().top){var u=s.getBoundingClientRect().top;u<=r.topmargin?(c.pos=u,null===o&&(o=c),o.pos<c.pos&&(o=c)):null===o&&(o=c)}}e.height+t>=e.maxHeight&&(o=i[r.spyElems[r.spyElems.length-1].id]),o&&o.set()});r.$on("destroy",function(){e.removeHandler(s)})}};return{restrict:"A",scope:{selector:"@",topmargin:"@"},link:r}}]),e.directive("pagemenu",["$compile","$location","$anchorScroll",function(t,e,o){var r=function(r,i,l){for(var s,c=[],u=[],a=function(t){for(var n={link:t.id,text:t.textContent||t.innerText,parent:""},e=t.tagName,o=0;o<t.classList.length;o++)e+=","+t.classList[o];var r=c.length;if(0===r)c.push(e);else if(e!==c[r-1]){for(var i=r-1;i>=0&&e!=c[i];i--);if(0>i)c.push(e),n.push=!0,u.push(s);else for(n.pop=r-1-i;c.length>i+1;)c.pop(),u.pop()}return u.length>0&&(n.parent=u[u.length-1]),s=n.link,n},f=n().items(),h="",d=0;d<f.length;d++){var p=a(f[d]);if(p.push)h+='<menu class="nav '+(l?l:"")+'">';else if(p.pop)for(var g=0;g<p.pop;g++)h+="</li></menu>";else 0!==d&&(h+="</li>");h+='<li pagemenuspy="'+p.link+'" parent="'+p.parent+'">',h+='<a href="#'+p.link+'">',h+=p.text,h+="</a>"}h+="</li>",i.html(h),t(i.contents())(r),i.on("click",function(t){var r=t.target.hash.substring(1);e.hash(r),o(),t.preventDefault(),0!==n().topMargin()&&setTimeout(function(){window.scrollTo(window.pageXOffset,window.pageYOffset-n().topMargin())},0)})};return{restrict:"E",replace:!0,template:'<menu class="nav pagemenu"></menu>',link:function(t,e,o){n().setBuilder(function(){r(t,e,o.childClasses)})}}}]),e.directive("pagemenuspy",["$location","$anchorScroll",function(){return{restrict:"A",link:function(t,e,o){n().addSpy({id:o.pagemenuspy,parent:o.parent,set:function(){e.addClass("active");var t=n().getSpy(this.parent);t&&t.set()},clear:function(){e.removeClass("active")}})}}}])}(angular);